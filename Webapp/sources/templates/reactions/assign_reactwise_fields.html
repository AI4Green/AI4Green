{% extends "base.html" %}

{% block title %}Assign Unknown Fields{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/custom_colours.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/reaction_table/reaction_table.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/reactwise.js') }}"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/reaction_constructor.css') }}">

{% endblock %}

{% block content %}
    <!-- Floating Progress Tracker -->
<div id="progress-tracker" style="
    position: fixed;
    top: 100px;
    left: 20px;
    z-index: 1050;
    background-color: rgba(255, 255, 255, 0.95);
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: sans-serif;
    font-size: 0.9rem;
">
    <span id="tracker-icon" style="font-size: 1.5rem; color: red;">&#10060;</span>
    <span id="tracker-text" style="color: #333;">Assign the unrecognised fields to complete set up!</span>
    <a id="tracker-button" href="/next_step" class="btn btn-success btn-sm" style="display: none; margin-left: 10px;">
        Click to progress
    </a>

{#    <script>#}
{#    function updateTracker() {#}
{#        const solventCards = document.querySelectorAll('#assign-solvents .card[tabindex="0"]');#}
{#        const variableCards = document.querySelectorAll('#assign-variables .card[tabindex="0"]');#}
{#        const compoundCards = document.querySelectorAll('#assign-compounds .card[tabindex="0"]');#}
{##}
{#        const unresolved = solventCards.length + variableCards.length + compoundCards.length;#}
{##}
{#        const icon = document.getElementById('tracker-icon');#}
{#        const text = document.getElementById('tracker-text');#}
{#        const button = document.getElementById('tracker-button');#}
{##}
{#        if (unresolved > 0) {#}
{#            icon.innerHTML = '&#10060;'; // Red cross#}
{#            icon.style.color = 'red';#}
{#            text.textContent = 'There are still unrecognised fields';#}
{#            button.style.display = 'none';#}
{#        } else {#}
{#            icon.innerHTML = '&#9989;'; // Green tick#}
{#            icon.style.color = 'green';#}
{#            text.textContent = 'All fields recognised!';#}
{#            button.style.display = 'inline-block';#}
{#        }#}
{#    }#}
{##}
{#    // Attach IDs to sections for tracking#}
{#    document.querySelector('[action="/assign_solvents"]')?.setAttribute('id','assign-solvents');#}
{#    document.querySelector('[action="/assign_variables"]')?.setAttribute('id','assign-variables');#}
{#    document.querySelector('[action="/assign_novel_compounds"]')?.setAttribute('id','assign-compounds');#}
{##}
{#    // Initial check#}
{#    updateTracker();#}
{##}
{#    // Observe DOM changes to auto-update#}
{#    const observer = new MutationObserver(updateTracker);#}
{#    observer.observe(document.body, { childList: true, subtree: true });#}
{#    </script>#}
</div>

<div class="container py-4">

    <!-- Reaction Overview Card -->
    <div class="card mb-5 border rounded shadow-sm">
        <div class="card-header bg-light border-bottom p-3">
            <h4 class="mb-1 text-dark">Reaction Overview</h4>
            <small class="text-muted">Reaction scheme, solvents, and reagents.</small>
        </div>
        <div class="card-body">

            <!-- Reaction Scheme -->
            <div class="mb-4">
                <div class="text-center">
                    {% if reaction_scheme_image %}
                        <img src="data:image/png;base64,{{ reaction_scheme_image }}"
                             alt="Reaction Scheme"
                             class="img-fluid border rounded"
                             style="max-height: 300px; object-fit: contain;">
                    {% else %}
                        <p class="text-muted">No reaction scheme available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <h2 class="mb-4 text-center">Assign Unknown Reaction Fields</h2>

    <!-- Unknown Solvents Section -->
    <div class="card mb-5 border rounded shadow-sm" id="unknown-solvents-card">
        <div class="card-header bg-light border-bottom p-3">
            <h4 class="mb-1 text-dark">Unknown Solvents</h4>
            <small class="text-muted">Match each solvent to the correct reaction component before completing the import.</small>
        </div>
        <div class="card-body">
            {% if unknown_solvents %}
                <div class="row g-3">
                    {% for solvent, exps in unknown_solvents.items() %}
                        <div class="col-md-6" id="unknown-solvent-card-{{ loop.index }}">
                            <div class="card p-3 border rounded shadow-sm h-100"
                                 style="min-height: 120px; transition: transform 0.2s;"
                                 tabindex="0" role="group" aria-labelledby="label-{{ loop.index }}">
                                <label id="unknown-solvent-name-{{ loop.index }}" class="form-label fw-bold"
                                       for="solvent_assignment_{{ loop.index }}">
                                    {{ solvent }}
                                </label>
                                <input type="search" class="remove-highlight-filled-cell solvent-input"
                                       id="js-solvent{{ loop.index }}" autocomplete="off"
                                       placeholder="Name or CAS Number"
                                       list="js-solvent-datalist">
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary" onclick="assignSolvents({{ unknown_solvents }})">Save Solvent Assignments</button>
                </div>
            {% else %}
                <p class="text-muted">No unknown solvents to assign.</p>
            {% endif %}
        </div>
    </div>

    <!-- Unknown Continuous Variables Section -->
    <div class="card mb-5 border rounded shadow-sm">
        <div class="card-header bg-light border-bottom p-3">
            <h4 class="mb-1 text-dark">Unknown Continuous Variables</h4>
            <small class="text-muted">
                Match each field to the correct reaction component and define its type.
            </small>
        </div>
        <div class="card-body">
            {% if unknown_variables %}
                <form method="post" action="/assign_variables">
                    <div class="row g-3">
                        {% for variable in unknown_variables %}
                            <div class="col-md-6">
                                <div class="card p-3 border rounded shadow-sm h-100"
                                     style="min-height: 180px; transition: transform 0.2s;"
                                     tabindex="0" role="group" aria-labelledby="label-var-{{ loop.index }}">

                                    <!-- Variable Label -->
                                    <label id="label-var-{{ loop.index }}" class="form-label fw-bold"
                                           for="variable_assignment_{{ loop.index }}">
                                        {{ variable }}
                                    </label>

                                    <!-- Type Selection -->
                                    <div class="mb-3">
                                        <select class="form-select form-select-sm variable-type-select"
                                                data-target="{{ loop.index }}" required>
                                            <option value="" disabled selected>Select type</option>
                                            <option value="chemical">Chemical</option>
                                            <option value="amount">Amount</option>
                                        </select>
                                    </div>

                                    <!-- Chemical structure input -->
                                    <div class="chemical-input mt-2" id="chemical-{{ loop.index }}" style="display:none;">
                                        <button type="button" class="btn btn-outline-secondary w-100">
                                            Draw/Upload Chemical Structure
                                        </button>
                                    </div>

                                    <!-- Amount input -->
                                    <div class="amount-input mt-2" id="amount-{{ loop.index }}" style="display:none;">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-borderless mb-0">
                                                <thead>
                                                    <tr>
                                                        <th scope="col" class="fw-normal text-muted">Select Reaction Component</th>
                                                        <th scope="col" class="fw-normal text-muted">Select Unit</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <select name="variable_assignment_{{ loop.index }}"
                                                                    class="form-select form-select-sm" required>
                                                                <option value="" disabled selected>Choose component</option>
                                                                {% for component in reaction_components %}
                                                                    <option value="{{ component }}">{{ component }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select name="variable_unit_{{ loop.index }}"
                                                                    class="form-select form-select-sm" required>
                                                                <option value="" disabled selected>Choose unit</option>
                                                                <option value="equivalent">Equivalent</option>
                                                                <option value="mass">Mass</option>
                                                                <option value="volume">Volume</option>
                                                                <option value="concentration">Concentration</option>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-success">Save Variable Assignments</button>
                    </div>
                </form>
            {% else %}
                <p class="text-muted">No unknown continuous variables to assign.</p>
            {% endif %}
        </div>
    </div>

    <!-- Novel Compounds Section -->
    <div class="card mb-5 border rounded shadow-sm" >
        <div class="card-header bg-light border-bottom p-3">
            <h4 class="mb-1 text-dark">Novel Compounds</h4>
            <small class="text-muted">
                These compounds were not recognized in the system. Please provide their details.
            </small>
        </div>
        <div class="card-body">
            {% if novel_compounds %}
                <form method="post" action="/assign_novel_compounds">
                    <div class="row g-3">
                        {% for compound in novel_compounds %}
                            <div class="col-6">
                                <div class="card p-3 border rounded shadow-sm h-100" tabindex="0">
                                    <h5 class="mb-2">{{ compound.component }} {{ compound.number }}</h5>

                                    {# Chemical structure image #}
                                    {% if compound.image_base64 %}
                                        <div class="text-center mb-3">
                                            <img src="data:image/png;base64,{{ compound.image_base64 }}"
                                                 alt="Chemical structure of {{ compound.name or 'compound' }}"
                                                 class="img-fluid border rounded" id="novel-compound-image-{{ compound.number }}"
                                                 style="max-height: 200px; object-fit: contain;">
                                        </div>
                                    {% else %}
                                        <p class="text-muted text-center">No structure available</p>
                                    {% endif %}

                                    {# Existing novel compound input partial #}
                                    {% set component = compound.component %}
                                    {% set number = compound.number %}
                                    {% set name = compound.name %}
                                    {% set mw = compound.mw %}
                                    {% set smiles = compound.smiles %}
                                    {% set polymer = compound.polymer %}
                                    {% include "reactions/_novel_compound.html" %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-warning">Save Novel Compounds</button>
                    </div>
                </form>
            {% else %}
                <p class="text-muted">No novel compounds to define.</p>
            {% endif %}
        </div>
    </div>

</div>

<input type="hidden" id="js-active-workbook" value="{{ workbook_name }}">
<input type="hidden" id="js-active-workgroup" value="{{ workgroup_name }}">
<input type="hidden" id="js-number-of-unknown-solvents" value="{{ number_of_solvents }}">

<datalist id="js-solvent-datalist" class="solvent-datalist">
{% for sol in sol_rows %}
  <option value="{{ sol.name }}" class='datalistOption
    {% if sol.flag == 1 %}hazard-highly-hazardous
    {% elif sol.flag == 2 %}hazard-hazardous
    {% elif sol.flag == 3 %}hazard-warning
    {% elif sol.flag == 4 %}hazard-acceptable
    {% else %}hazard-reset-hazard{% endif %}'>
    {{ sol.name }}
  </option>
{% endfor %}
</datalist>


<!-- Hover/focus effect -->
<style>
.card[tabindex="0"]:hover,
.card[tabindex="0"]:focus {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    outline: none;
}
</style>

<!-- Show/Hide inputs based on type selection -->
<script>
document.querySelectorAll('.variable-type-select').forEach(select => {
    select.addEventListener('change', function() {
        const id = this.dataset.target;
        const chemicalDiv = document.getElementById('chemical-' + id);
        const amountDiv = document.getElementById('amount-' + id);

        if (this.value === 'chemical') {
            chemicalDiv.style.display = 'block';
            amountDiv.style.display = 'none';
        } else if (this.value === 'amount') {
            chemicalDiv.style.display = 'none';
            amountDiv.style.display = 'block';
        } else {
            chemicalDiv.style.display = 'none';
            amountDiv.style.display = 'none';
        }
    });
});

console.log("DDDD")

let solventDatalistID = "js-solvent-datalist"
let solventInputID = "js-solvent"
let solventNumber = 1

$("#js-solvent-datalist")
.clone()
.prop("id", "js-solvent-datalist1")
.appendTo("#js-solvent1");

console.log($("#js-solvent1"))
setColours();
// datalist_initiate fns without the reaction table stuff
autofillSolventData(1);
autofillSolventFields2();
  for (let option of document.getElementById(solventDatalistID).options) {
    option.onclick = function () {
      document.getElementById(solventInputID).value = option.value;
      document.getElementById(solventDatalistID).style.display = "none";
      document.getElementById(solventInputID).style.borderRadius = "5px";
      postSolventData(option.value, solventNumber, true);
    };
  }
  // hide the solvent dropdown if clicking on non-dropdown/input element
  let $solventInputID = "#" + solventInputID;
  $(document).on("click", function (event) {
    let $target = $(event.target);
    let $solventDatalistID = "#" + solventDatalistID;
    if (
      !$target.closest($solventDatalistID).length &&
      !$target.closest($solventInputID).length &&
      $($solventDatalistID).is(":visible")
    ) {
      $($solventDatalistID).hide();
    } else {
    }
  });

// datalist_initiate("js-solvent", "js-solvent-datalist1", 1)
</script>



<!-- Optional: add hover/focus effect -->
<style>
.card[tabindex="0"]:hover,
.card[tabindex="0"]:focus {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    outline: none;
}
.card-toast {
  position: absolute;
  top: 8px;
  right: 8px;
  background-color: #f8d7da; /* light red */
  color: #721c24; /* dark red text */
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 0.85rem;
  opacity: 1;
  transition: opacity 1s ease-out, transform 1s ease-out;
  pointer-events: none; /* so it doesn't block clicks */
  z-index: 10;
}

.card-toast.fade-out {
  opacity: 0;
  transform: translateY(-10px);
}

.card.position-relative {
  position: relative; /* make card a positioning context */
}
</style>

{% endblock %}
